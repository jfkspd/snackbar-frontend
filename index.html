<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Snack Bar — Connectivity Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body{font:16px system-ui, sans-serif; margin:24px;}
      .ok{color:#065f46} .warn{color:#7f1d1d}
      code{background:#f3f4f6; padding:2px 6px; border-radius:6px}
    </style>
  </head>
  <body>
    <h1>Snack Bar — Connectivity Test</h1>
    <p>If you can read this on SCUSD Wi-Fi, static hosting is OK ✅</p>
    <h2>Fetch Test</h2>
    <p id="status">Running fetch test…</p>
   <script>
/** Use the same working CSV link you just verified */
const ITEMS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTTtlEwo0hKcYdsMdjhp71Wq1NWDTEwIkdytSm_E1EQfv1x8FHx8sEzyhQoym44_RX2mp2FXvN3jCwf/pub?gid=0&single=true&output=csv';

const statusEl = document.getElementById('status');
const itemsEl = document.getElementById('items');

run();

async function run(){
  statusEl.textContent = 'Fetching Items…';
  try{
    const res = await fetch(ITEMS_CSV_URL, { cache:'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    const csv = await res.text();
    const rows = parseCSV(csv);
    if(!rows.length) throw new Error('CSV is empty');

    const items = rowsToItems(rows);
    statusEl.innerHTML = `<span class="ok">Fetched & parsed!</span> Found <strong>${items.length}</strong> active items.`;
    renderItems(items);
  }catch(err){
    statusEl.innerHTML = `<span class="warn">Fetch FAILED</span> — ${err && err.message || err}`;
  }
}

/** CSV parser that handles quoted commas/newlines */
function parseCSV(text){
  const rows = [];
  let i=0, f='', r=[], inQ=false;
  const pushF=()=>{ r.push(f); f=''; };
  const pushR=()=>{ rows.push(r); r=[]; };
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c==='"'){
        if(text[i+1]==='"'){ f+='"'; i+=2; continue; }
        inQ=false; i++; continue;
      }
      f+=c; i++; continue;
    }
    if(c==='"'){ inQ=true; i++; continue; }
    if(c===','){ pushF(); i++; continue; }
    if(c==='\r'){ i++; continue; }
    if(c==='\n'){ pushF(); pushR(); i++; continue; }
    f+=c; i++;
  }
  pushF(); if(r.length) pushR();
  return rows;
}

/** Map rows -> items using header names (case-insensitive) */
function rowsToItems(rows){
  const headers = rows[0].map(h => String(h).trim().toLowerCase());
  const idx = {
    item_id: headers.indexOf('item_id'),
    name: headers.indexOf('name'),
    price: headers.indexOf('price'),
    active: headers.indexOf('active')
  };
  const missing = Object.entries(idx).filter(([,i]) => i === -1).map(([k]) => k);
  if(missing.length){
    throw new Error('Missing columns: ' + missing.join(', ') + ' (need item_id,name,price,active)');
  }
  return rows.slice(1)
    .map(row => ({
      item_id: String(row[idx.item_id] ?? '').trim(),
      name: String(row[idx.name] ?? '').trim(),
      price: Number(row[idx.price]),
      active: toBool(row[idx.active])
    }))
    .filter(it => it.active && it.item_id && Number.isFinite(it.price))
    .sort((a,b) => a.name.localeCompare(b.name));
}

function toBool(v){
  const s = String(v).trim().toLowerCase();
  return v === true || s === 'true' || s === '1' || s === 'yes';
}

function renderItems(items){
  if(!items.length){
    itemsEl.innerHTML = '<p class="warn">No active items found.</p>';
    return;
  }
  const list = items.map(it =>
    `<li><code>${esc(it.item_id)}</code> — ${esc(it.name)} — $${it.price.toFixed(2)}</li>`
  ).join('');
  itemsEl.innerHTML = `<p><strong>${items.length}</strong> active items</p><ul>${list}</ul>`;
}

function esc(s){
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}
</script>

  </body>
</html>
