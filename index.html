<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Snack Bar Register</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body{font:16px system-ui, sans-serif; margin:24px;}
      .ok{color:#065f46} .warn{color:#7f1d1d}
      code{background:#f3f4f6; padding:2px 6px; border-radius:6px}
      .grid{display:grid; gap:10px; grid-template-columns:repeat(auto-fill,minmax(180px,1fr));}
      .card{background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:10px;}
      .row{display:flex; justify-content:space-between; align-items:center; gap:8px;}
      .name{font-weight:600;} .price{font-weight:700;} .id{color:#475569;font-size:12px;}
      .stepper{display:inline-flex; align-items:center; border:1px solid #e2e8f0; border-radius:999px; background:#f8fafc;}
      .btn{border:0; background:transparent; padding:6px 10px; font-size:16px; cursor:pointer;}
      .qty{min-width:28px; text-align:center; padding:0 6px; background:#fff;
           border-left:1px solid #e2e8f0; border-right:1px solid #e2e8f0; font-variant-numeric: tabular-nums;}
      .summary{color:#475569; margin:6px 0 10px;}
    </style>
  </head>
  <body>
    <h1>Snack Bar Register</h1>
    <p id="status">Loading…</p>

    <label for="q">Search</label>
    <input id="q" type="search" placeholder="e.g., chips, soda, 0003"
           style="width:min(520px,95%); padding:8px; margin:8px 0; font-size:16px;">

    <h2>Items</h2>
    <p id="summary" class="summary">0 items — $0.00</p>
    <button id="testSubmit">Test Submit (prefilled form)</button>
    <button id="oneClick">One-click Submit (silent)</button>
    <button id="selfTest">Proxy Self-Test</button>

    <div id="items" class="grid" aria-live="polite"></div>

    <iframe name="formTarget" style="display:none;"></iframe>

    <script>
    /** CONFIG **/
    const ITEMS_CSV_URL =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vTTtlEwo0hKcYdsMdjhp71Wq1NWDTEwIkdytSm_E1EQfv1x8FHx8sEzyhQoym44_RX2mp2FXvN3jCwf/pub?gid=0&single=true&output=csv';

    const PROXY_URL = 'https://snackbar-form-proxy.chris-herner.workers.dev/';

    const FORM_BASE =
      'https://docs.google.com/forms/d/e/1FAIpQLScbRVY7T_IKUPx_xYcDlyncM0TV09piz-xd_eLSO04O7gd0TA/viewform';

    const ENTRY = {
      order_id:       'entry.1662144781',
      payment_method: 'entry.1579496181',
      subtotal:       'entry.1026596473',
      paid:           'entry.459825042',
      change:         'entry.1466509759',
      item_id:        'entry.187752476',
      name:           'entry.1735654032',
      price_each:     'entry.224726774',
      qty:            'entry.348979745',
      line_total:     'entry.1281301043',
    };

    /** DOM **/
    const statusEl  = document.getElementById('status');
    const itemsEl   = document.getElementById('items');
    const summaryEl = document.getElementById('summary');
    const qInput    = document.getElementById('q');
    const testBtn   = document.getElementById('testSubmit');
    const oneBtn    = document.getElementById('oneClick');
    const selfBtn   = document.getElementById('selfTest');

    /** State **/
    const fmt = new Intl.NumberFormat('en-US', { style:'currency', currency:'USD' });
    let ALL_ITEMS = [];
    let VIEW = [];
    const CART = new Map();

    run();

    async function run(){
      try {
        const res = await fetch(ITEMS_CSV_URL, {cache:'no-store'});
        const csv = await res.text();
        const rows = parseCSV(csv);
        ALL_ITEMS = rowsToItems(rows);
        VIEW = ALL_ITEMS.slice();
        statusEl.innerHTML = `<span class="ok">Fetched & parsed!</span> Found <strong>${ALL_ITEMS.length}</strong> items.`;
        renderItems(VIEW); wireSearch(); updateSummary();
        testBtn.onclick = onTestSubmit;
        oneBtn.onclick = onOneClick;
        selfBtn.onclick = onSelfTest;
      } catch(e){
        statusEl.innerHTML = `<span class="warn">Error:</span> ${e}`;
      }
    }

    /** CSV parser **/
    function parseCSV(text){
      const rows=[]; let i=0,f='',r=[],q=false;
      const pushF=()=>{r.push(f);f='';}; const pushR=()=>{rows.push(r);r=[];};
      while(i<text.length){
        const c=text[i];
        if(q){ if(c=='"'){ if(text[i+1]=='"'){f+='"';i+=2;continue;} q=false;i++;continue;}
          f+=c; i++; continue;}
        if(c=='"'){q=true;i++;continue;}
        if(c==','){pushF();i++;continue;}
        if(c=='\r'){i++;continue;}
        if(c=='\n'){pushF();pushR();i++;continue;}
        f+=c;i++;
      } pushF(); if(r.length) pushR(); return rows;
    }
    function rowsToItems(rows){
      const h=rows[0].map(x=>x.toLowerCase().trim());
      const idx={id:h.indexOf('item_id'), name:h.indexOf('name'),
                 price:h.indexOf('price'), active:h.indexOf('active')};
      return rows.slice(1).map(r=>({
        item_id:r[idx.id], name:r[idx.name], price:+r[idx.price], active:/^(true|1|yes)$/i.test(r[idx.active])
      })).filter(x=>x.active).sort((a,b)=>a.name.localeCompare(b.name));
    }

    function renderItems(items){
      itemsEl.innerHTML = items.map(it=>{
        const q=CART.get(it.item_id)?.qty||0;
        return `<div class="card" data-id="${it.item_id}">
          <div class="row"><div class="name">${it.name}</div><div class="price">${fmt.format(it.price)}</div></div>
          <div class="row"><span class="id">ID ${it.item_id}</span>
            <div class="stepper"><button class="btn" data-action="dec">−</button>
            <span class="qty">${q}</span><button class="btn" data-action="inc">＋</button></div></div>
        </div>`;
      }).join('');
      itemsEl.onclick = e=>{
        const btn=e.target.closest('[data-action]'); if(!btn)return;
        const id=btn.closest('.card').dataset.id;
        if(btn.dataset.action==='inc')inc(id); else dec(id);
      };
    }
    function inc(id){const it=ALL_ITEMS.find(x=>x.item_id==id);if(!it)return;
      const prev=CART.get(id)?.qty||0; CART.set(id,{...it,qty:prev+1});
      renderItems(VIEW); updateSummary();}
    function dec(id){const it=ALL_ITEMS.find(x=>x.item_id==id);if(!it)return;
      const prev=CART.get(id)?.qty||0;const next=Math.max(0,prev-1);
      if(next==0)CART.delete(id);else CART.set(id,{...it,qty:next});
      renderItems(VIEW); updateSummary();}
    function updateSummary(){
      let c=0,s=0; for(const {price,qty} of CART.values()){c+=qty;s+=price*qty;}
      summaryEl.textContent=`${c} items — ${fmt.format(s)}`;
    }
    function wireSearch(){let t;qInput.oninput=()=>{clearTimeout(t);t=setTimeout(()=>{
      const n=qInput.value.toLowerCase();
      VIEW=!n?ALL_ITEMS:ALL_ITEMS.filter(it=>it.name.toLowerCase().includes(n)||it.item_id.includes(n));
      renderItems(VIEW);},120);}}

    /** Buttons **/
    function onTestSubmit(){
      const first=CART.values().next().value; if(!first){alert("Add an item first");return;}
      const orderId="O"+Date.now(),subtotal=first.price*first.qty;
      const p=new URLSearchParams();
      p.set(ENTRY.order_id,orderId);p.set(ENTRY.payment_method,'cash');
      p.set(ENTRY.subtotal,subtotal);p.set(ENTRY.paid,subtotal);
      p.set(ENTRY.change,0);p.set(ENTRY.item_id,first.item_id);
      p.set(ENTRY.name,first.name);p.set(ENTRY.price_each,first.price);
      p.set(ENTRY.qty,first.qty);p.set(ENTRY.line_total,subtotal);
      window.open(`${FORM_BASE}?usp=pp_url&${p.toString()}`,'_blank');
    }

    async function onOneClick(){
      const first=CART.values().next().value; if(!first){alert("Add an item first");return;}
      const orderId="O"+Date.now(),subtotal=first.price*first.qty;
      const payload={}; payload[ENTRY.order_id]=orderId;
      payload[ENTRY.payment_method]='cash';
      payload[ENTRY.subtotal]=subtotal;
      payload[ENTRY.paid]=subtotal;
      payload[ENTRY.change]=0;
      payload[ENTRY.item_id]=first.item_id;
      payload[ENTRY.name]=first.name;
      payload[ENTRY.price_each]=first.price;
      payload[ENTRY.qty]=first.qty;
      payload[ENTRY.line_total]=subtotal;
      const res=await fetch(PROXY_URL,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
      const j=await res.json();
      statusEl.innerHTML+=`<div>${JSON.stringify(j)}</div>`;
    }

      async function onSelfTest(){
  const now = new Date();
  const orderId = 'TEST' + now.toISOString().replace(/[-:.TZ]/g,'').slice(0,14);
  const payload = {
    'entry.1662144781': orderId,     // order_id
    'entry.1579496181': 'cash',      // payment_method
    'entry.1026596473': 1.00,        // subtotal
    'entry.459825042':  1.00,        // paid
    'entry.1466509759': 0.00,        // change
    'entry.187752476':  'TEST1',     // item_id
    'entry.1735654032': 'PROXY SELF TEST', // name
    'entry.224726774':  1.00,        // price_each
    'entry.348979745':  1,           // qty
    'entry.1281301043': 1.00         // line_total
  };

  try{
    const res = await fetch('https://snackbar-form-proxy.chris-herner.workers.dev/', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const json = await res.json();
    if (json && json.ok) {
      statusEl.innerHTML += `<div class="ok">Proxy self-test OK (order ${orderId}). Check Form Responses 1.</div>`;
    } else {
      statusEl.innerHTML += `<div class="warn">Proxy self-test failed — ${json && json.status || res.status}</div>`;
    }
  } catch(err){
    statusEl.innerHTML += `<div class="warn">Proxy self-test error — ${err && err.message || err}</div>`;
  }
}

    
    </script>
  </body>
</html>
